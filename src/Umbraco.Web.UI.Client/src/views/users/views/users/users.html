<div ng-controller="Umbraco.Editors.Users.UsersController as vm" class="clearfix">



  <umb-load-indicator ng-show="vm.loading"></umb-load-indicator>

  <!-- Users Overview -->
  <div ng-if="vm.usersViewState === 'overview'">

    <umb-editor-sub-header>

      <!-- No selection -->
      <umb-editor-sub-header-content-left ng-if="vm.selection.length === 0">
        <umb-button-group ng-if="vm.defaultButton"
                          default-button="vm.defaultButton"
                          sub-buttons="vm.subButtons">
        </umb-button-group>
      </umb-editor-sub-header-content-left>

      <umb-editor-sub-header-content-right ng-if="vm.selection.length === 0">
        <umb-editor-sub-header-section>
          <umb-layout-selector ng-if="vm.layouts"
                               layouts="vm.layouts"
                               active-layout="vm.activeLayout"
                               on-layout-select="vm.selectLayout">
          </umb-layout-selector>
        </umb-editor-sub-header-section>
        <umb-editor-sub-header-section>
          <div class="form-search -no-margin-bottom pull-right">
            <div class="inner-addon left-addon">
              <i class="icon icon-search"></i>
              <input class="form-control search-input"
                     type="text"
                     localize="placeholder"
                     placeholder="@general_typeToSearch"
                     ng-model="vm.usersOptions.filter"
                     ng-change="vm.searchUsers()"
                     prevent-enter-submit
                     no-dirty-check>
            </div>
          </div>
        </umb-editor-sub-header-section>
      </umb-editor-sub-header-content-right>

      <!-- With selection -->
      <umb-editor-sub-header-content-left ng-if="vm.selection.length > 0">
        <umb-editor-sub-header-section>
          <umb-button type="button"
                      label="Clear selection"
                            size="xs"
                      label-key="buttons_clearSelection"
                      action="vm.clearSelection()"
                      disabled="actionInProgress">
          </umb-button>
        </umb-editor-sub-header-section>
        <umb-editor-sub-header-section>
          <strong>{{ vm.selection.length }} <localize key="general_of">of</localize> {{ vm.users.length }} <localize key="general_selected">selected</localize></strong>
        </umb-editor-sub-header-section>
      </umb-editor-sub-header-content-left>

      <umb-editor-sub-header-content-right ng-if="vm.selection.length > 0">
        <div style="margin-right: 5px;">
          <umb-button ng-if="vm.allowSetUserGroup"
                      type="button"
                            size="xs"
                      label="Set group"
                      icon="icon-users"
                      action="vm.setUserGroup()">
          </umb-button>
        </div>
        <div style="margin-right: 5px;">
          <umb-button ng-if="vm.allowEnableUser"
                      type="button"
                            size="xs"
                            state="vm.enableUserButtonState"
                      label="Enable"
                      icon="icon-check"
                            action="vm.enableUsers()">
          </umb-button>
        </div>
        <div>
          <umb-button ng-if="vm.allowDisableUser"
                      type="button"
                            size="xs"
                            state="vm.disableUserButtonState"
                      label="Disable"
                      icon="icon-block"
                            action="vm.disableUsers()">
          </umb-button>
        </div>
      </umb-editor-sub-header-content-right>

    </umb-editor-sub-header>

    <!-- Filters -->
    <div style="margin-bottom: 20px;" class="flex items-center">

      <div style="font-size: 16px;">
        <span class="bold">Users</span> <span>({{vm.usersOptions.totalItems}})</span>
      </div>

      <div class="flex" style="margin-left: auto;">

        <!-- State filter -->
        <div class="dropdown pull-right" ng-if="vm.userStatesFilter.length > 0">
          <a class="btn btn-link dropdown-toggle flex" href="" ng-click="vm.showStatusFilter = !vm.showStatusFilter">
            <span>Status:</span>
            <span class="bold truncate dib" style="margin-left: 5px; margin-right: 3px; max-width: 150px;">{{ vm.getFilterName(vm.userStatesFilter) }}</span>
            <span class="caret"></span>
          </a>
          <ul ng-if="vm.showStatusFilter" on-outside-click="vm.showStatusFilter = false;" class="dropdown-menu db" role="menu" aria-labelledby="dropdownMenu">
            <li ng-repeat="userState in vm.userStatesFilter" style="padding: 5px 10px;">
              <div class="flex items-center">
                <input style="margin-right: 7px; margin-top: 2px;" type="checkbox" ng-model="userState.selected" ng-change="vm.setUserStatesFilter(userState.key)" />
                {{ userState.name }} ({{userState.count}})
              </div>
            </li>
          </ul>
        </div>

        <!-- Groups filter -->
        <div class="dropdown pull-right">
          <a class="btn btn-link dropdown-toggle flex" href="" ng-click="vm.showGroupFilter = !vm.showGroupFilter">
            <span><localize key="general_groups"></localize>:</span>
            <span class="bold truncate dib" style="margin-left: 5px; margin-right: 3px; max-width: 150px;">{{ vm.getFilterName(vm.userGroups) }}</span>
            <span class="caret"></span>
          </a>
          <ul ng-if="vm.showGroupFilter" on-outside-click="vm.showGroupFilter = false;" class="dropdown-menu db" role="menu" aria-labelledby="dropdownMenu">
            <li ng-repeat="userGroup in vm.userGroups" style="padding: 5px 10px;">
              <div class="flex items-center">
                <input style="margin-right: 7px; margin-top: 2px;" type="checkbox" ng-model="userGroup.selected" ng-change="vm.setUserGroupFilter(userGroup)"  />
                {{ userGroup.name }}
              </div>
            </li>
          </ul>
        </div>

        <!-- Order By -->
        <div class="dropdown pull-right">
          <a class="btn btn-link dropdown-toggle flex" href="" data-toggle="dropdown">
            <span>Order by:</span>
            <span class="bold" style="margin-left: 2px;">{{ vm.getSortLabel(vm.usersOptions.orderBy, vm.usersOptions.orderDirection) }} </span>
            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
            <li ng-repeat="sortData in vm.userSortData">
              <a tabindex="-1" href="#" ng-click="vm.setOrderByFilter(sortData.key, sortData.direction)" prevent-default>{{sortData.label}}</a>
            </li>            
          </ul>
        </div>

      </div>

    </div>

    <!-- Empty states -->
    <umb-empty-state ng-if="!vm.users && vm.usersOptions.filter.length > 0"
                     position="center">
      <localize key="general_searchNoResult"></localize>
    </umb-empty-state>

    <!-- Layout: Cards -->
    <div class="umb-user-cards" ng-if="vm.activeLayout.path === '1' && vm.loading === false">
      <a href="" class="umb-user-card" ng-repeat="user in vm.users" ng-click="vm.clickUser(user)">
        <div class="umb-user-card__content" ng-class="{'umb-user-card__content--selected': user.selected}">
          <umb-badge class="umb-user-card__badge"
                     size="xs"
                     ng-if="user.userDisplayState.key !== 'Active'"
                     color="{{user.userDisplayState.color}}">
            {{ user.userDisplayState.name }}
          </umb-badge>
          <div class="umb-user-card__avatar">
            <umb-avatar size="l"
                        color="secondary"
                        name="{{user.name}}"
                        img-src="{{user.avatars[2]}}"
                        img-srcset="{{user.avatars[3]}} 2x, {{user.avatars[4]}} 3x">
            </umb-avatar>
          </div>
          <div class="umb-user-card__checkmark" ng-class="{'umb-user-card__checkmark--visible': user.selected || vm.selection.length > 0 }" ng-click="vm.selectUser(user, vm.selection, $event)">
            <umb-checkmark checked="user.selected" size="s"></umb-checkmark>
          </div>
          <div class="umb-user-card__name" href="">{{user.name}}</div>
          <div class="umb-user-card__group">
            <span ng-repeat="userGroup in user.userGroups">{{ userGroup.name }}<span ng-if="!$last">, </span></span>
          </div>
          <div class="umb-user-card__last-login">
            <div ng-if="user.formattedLastLogin">
              <div>Last login on</div>
              {{ user.formattedLastLogin }}
            </div>
            <div ng-if="!user.formattedLastLogin">
              <div>{{ user.name | umbWordLimit:1 }} has</div>
              not logged in yet
            </div>
          </div>
        </div>
      </a>
    </div>

    <!-- Layout: Table -->
    <div ng-if="vm.activeLayout.path === '2'">

      <table class="table">
        <thead>
          <tr>
            <th style="padding-left: 10px; width: 10px;">
              <a href="" style="text-decoration: none;" ng-click="vm.selectAll()"><umb-checkmark checked="vm.areAllSelected()" size="xs"></umb-checkmark></a>
            </th>
            <th style="width: 70px;"></th>
            <th>Name</th>
            <th>User group</th>
            <th>Last Login</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="user in vm.users" ng-click="vm.clickUser(user)" style="cursor: pointer;" ng-mouseenter="user.hover = true" ng-mouseleave="user.hover = false">
            <td style="padding-left: 10px;">
              <div ng-click="vm.selectUser(user, vm.selection, $event)">
              <umb-checkmark
                ng-if="vm.selection.length > 0 || user.hover"
                checked="user.selected"
                size="xs">
              </umb-checkmark>
              </div>
            </td>
            <td scope="row">
              <umb-avatar size="xs"
                          color="secondary"
                          name="{{user.name}}"
                          img-src="{{user.avatars[0]}}"
                          img-srcset="{{user.avatars[1]}} 2x, {{user.avatars[2]}} 3x">
              </umb-avatar>
            </td>
            <td class="bold">{{user.name}}</td>
            <td><span ng-repeat="userGroup in user.userGroups">{{ userGroup.name }}<span ng-if="!$last">, </span></span></td>
            <td>{{ user.formattedLastLogin }}</td>
            <td style="text-transform: capitalize;">
              <umb-badge size="xs"
                         ng-if="user.userDisplayState.key !== 'Active'"
                         color="{{user.userDisplayState.color}}">
                {{ user.userDisplayState.name }}
              </umb-badge>
            </td>
          </tr>
        </tbody>
      </table>

    </div>

    <!-- Pagination -->
    <div ng-if="!vm.loading" class="flex justify-center">
      <umb-pagination ng-if="vm.usersOptions.totalPages"
                      page-number="vm.usersOptions.pageNumber"
                      total-pages="vm.usersOptions.totalPages"
                      on-change="vm.changePageNumber(pageNumber)">
      </umb-pagination>
    </div>

  </div>

  <!-- Add user -->
  <div ng-if="vm.usersViewState === 'inviteUser' || vm.usersViewState === 'createUser'">

    <umb-editor-sub-header>
      <umb-editor-sub-header-content-left>
        <a class="umb-package-details__back-link" href="" ng-click="vm.setUsersViewState('overview');">&larr; <localize key="user_backToUsers">Back to users</localize></a>
      </umb-editor-sub-header-content-left>
    </umb-editor-sub-header>

    <div class="flex justify-center">
      <form name="addUserForm" no-validate val-form-manager style="max-width: 500px;" class="block-form">
        <div>
          <div ng-if="vm.usersViewState === 'inviteUser'">
            <h3 class="bold" style="margin-bottom: 0;"><localize key="user_inviteUser">Invite User</localize></h3>
            <p style="line-height: 1.6em; margin-bottom: 15px;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non libero vel turpis ultrices pharetra.</p>
          </div>
          <div ng-if="vm.usersViewState === 'createUser'">
            <h3 class="bold" style="margin-bottom: 0;"><localize key="user_createUser">Create user</localize></h3>
            <p style="line-height: 1.6em; margin-bottom: 15px;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non libero vel turpis ultrices pharetra.</p>
          </div>
        </div>

        <umb-control-group label="@general_name" label-for="name">
          <input type="text"
                 name="name"
                 localize="placeholder"
                 placeholder="@placeholders_entername"
                 class="input-block-level"
                 ng-model="vm.newUser.name"
                 umb-auto-focus
                 required
                 val-server-field="Name"/>
          <span class="help-inline" val-msg-for="name" val-toggle-msg="required"><localize key="general_required">Required</localize></span>
          <span class="help-inline" val-msg-for="name" val-toggle-msg="valServerField"></span>
        </umb-control-group>

        <umb-control-group label="@general_email" label-for="email">
          <input type="email"
                 name="email"
                 localize="placeholder"
                 placeholder="@placeholders_email"
                 class="input-block-level"
                 ng-model="vm.newUser.email"
                 required
                 val-email
                 val-server-field="Email"/>
          <span class="help-inline" val-msg-for="email" val-toggle-msg="required"><localize key="general_required">Required</localize></span>
          <span class="help-inline" val-msg-for="email" val-toggle-msg="valServerField"></span>
        </umb-control-group>

        <umb-control-group label="@user_usergroup">

          <umb-user-group-preview ng-repeat="group in vm.newUser.userGroups"
                                  icon="group.icon"
                                  name="group.name"
                                  sections="group.sections"
                                  content-start-nodes="group.startNodesContent"
                                  media-start-nodes="group.startNodesMedia"
                                  allow-remove="true"
                                  on-remove="vm.removeSelectedUserGroup($index, vm.newUser.userGroups)">
          </umb-user-group-preview>

          <a href=""
             style="max-width: 100%;"
             class="umb-node-preview-add"
             ng-click="vm.openUserGroupPicker($event)"
             prevent-default>
            <localize key="general_add">Add</localize>
          </a>

        </umb-control-group>

        <umb-control-group label="@general_message" ng-if="vm.usersViewState === 'inviteUser'" label-for="message">
          <textarea name="message"
                    type="text"
                    class="input-block-level"
                    localize="placeholder"
                    placeholder="@placeholders_entername"
                    ng-model="vm.newUser.message"
                    rows="4"
                    required
                    val-server-field="Message">
            </textarea>
            <span class="help-inline" val-msg-for="message" val-toggle-msg="required"><localize key="general_required">Required</localize></span>
            <span class="help-inline" val-msg-for="message" val-toggle-msg="valServerField"></span>
        </umb-control-group>

        <umb-button ng-if="vm.usersViewState === 'inviteUser'"
                    button-style="success"
                    state="vm.page.createButtonState"
                    type="button"
                    action="vm.inviteUser(addUserForm)"
                    label-key="user_sendInvite"
                    size="m">
        </umb-button>

        <umb-button ng-if="vm.usersViewState === 'createUser'"
                    button-style="success"
                    state="vm.page.createButtonState"
                    type="button"
                    action="vm.createUser(addUserForm)"
                    label-key="user_createUser"
                    size="m">
        </umb-button>

      </form>

    </div>
  </div>

  <!-- Create user success -->
  <div ng-if="vm.usersViewState === 'createUserSuccess'">
    <umb-editor-sub-header>
      <umb-editor-sub-header-content-left>
        <a class="umb-package-details__back-link" href="" ng-click="vm.setUsersViewState('overview');">&larr; <localize key="user_backToUsers">Back to users</localize></a>
      </umb-editor-sub-header-content-left>
    </umb-editor-sub-header>

    <div class="flex justify-center">
      <div style="max-width: 500px;" class="tc">
        <div class="flex justify-center" style="margin-bottom: 15px;">
          <umb-checkmark checked="vm.usersViewState === 'createUserSuccess'"
                         size="xl">
          </umb-checkmark>
        </div>
        <h3 class="bold" style="margin-bottom: 0;">{{vm.newUser.name | umbWordLimit:1}} has been created</h3>
        <p style="line-height: 1.6em; margin-bottom: 30px;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non libero vel turpis ultrices pharetra.</p>
        <div>
          <umb-button type="button"
                      button-style="info"
                      label-key="user_createAnotherUser"
                      action="vm.setUsersViewState('createUser');"
                      size="m">
          </umb-button>
          <umb-button type="button"
                      button-style="success"
                      label-key="user_goToProfile"
                      action="vm.goToUser(vm.newUser);"
                      size="m">
          </umb-button>
        </div>
      </div>
    </div>
  </div>

  <umb-overlay ng-if="vm.userGroupPicker.show"
               model="vm.userGroupPicker"
               view="vm.userGroupPicker.view"
               position="right">
  </umb-overlay>



</div>
