<div data-element="editor-logs" ng-controller="Umbraco.Editors.LogViewer.OverviewController as vm" class="clearfix">

    <umb-editor-view footer="false">

        <umb-editor-header
            name="'Logs'"
            name-locked="true"
            hide-icon="true"
            hide-description="true"
            hide-alias="true">
        </umb-editor-header>

        <umb-editor-container>

            <umb-load-indicator ng-if="vm.loading"></umb-load-indicator>

            <umb-editor-sub-header>
                <umb-editor-sub-header-content-left style="width:calc(100% - 350px - 20px);">
                    <!-- Log Level filter -->
                    <div style="position: relative;">
                        <a class="btn btn-link dropdown-toggle flex" href="" ng-click="vm.page.showLevelFilter = !vm.page.showLevelFilter">
                            <span>Log Levels:</span>
                            <span class="bold truncate dib" style="margin-left: 5px; margin-right: 3px; max-width: 150px;">{{ vm.getFilterName(vm.logLevels) }}</span>
                            <span class="caret"></span>
                        </a>
                        <umb-dropdown class="pull-right" ng-if="vm.page.showLevelFilter" on-close="vm.page.showLevelFilter = false;">
                            <umb-dropdown-item ng-repeat="level in vm.logLevels" style="padding: 8px 20px 8px 16px;">
                                <div class="flex items-center">
                                    <input
                                        id="loglevel-{{$index}}"
                                        type="checkbox"
                                        ng-model="level.selected"
                                        ng-change="vm.setLogLevelFilter(level)"
                                        style="margin-right: 10px; margin-top: -3px;" />
                                    <label for="loglevel-{{$index}}">{{ level.name }}</label>
                                </div>
                            </umb-dropdown-item>
                        </umb-dropdown>
                    </div>

                    <!-- Date Ranges -->
                    <span>From</span>
                    <umb-date-time-picker
                        options="vm.fromDatePickerConfig"
                        on-change="vm.datePickerChange(event)"
                        on-error="vm.datePickerError(event)">
                    </umb-date-time-picker>

                    <span>To</span>
                    <umb-date-time-picker
                        options="vm.toDatePickerConfig"
                        on-change="vm.datePickerChange(event)"
                        on-error="vm.datePickerError(event)">
                    </umb-date-time-picker>
                </umb-editor-sub-header-content-left>
            </umb-editor-sub-header>

            <umb-editor-sub-header>
                <umb-editor-sub-header-content-left style="width:calc(100% - 350px - 20px); position:relative;">
                    <!-- Search/expression filter -->
                    <input class="form-control search-input" type="text" ng-model="vm.logOptions.filterExpression" style="width:100%;" />
                    <umb-button
                        button-style="button"
                        type="button"
                        action="vm.search()"
                        label-key="general_search">
                    </umb-button>

                    <umb-dropdown ng-if="vm.something"  style="width: 100%; max-height: 250px; overflow-y: scroll; margin-top: -10px;" on-close="vm.dropdownOpen = false" umb-keyboard-list>
                        <umb-dropdown-item class="umb-variant-switcher__item" ng-class="{'umb-variant-switcher_item--current': variant.active}" ng-repeat="search in vm.searches">
                            <a href="" class="umb-variant-switcher__name-wrapper" ng-click="selectVariant($event, search)" prevent-default>
                                <span class="umb-variant-switcher__name">{{search.name}}</span>
                                <span>{{ search.query }}</span>
                            </a>
                        </umb-dropdown-item>
                    </umb-dropdown>

                </umb-editor-sub-header-content-left>
            </umb-editor-sub-header>

            <div class="umb-package-details" ng-if="!vm.loading">

                <div class="umb-package-details__main-content">

                    <!-- Loader for the main logs content when paging -->
                    <umb-load-indicator ng-if="vm.logsLoading"></umb-load-indicator>

                    <!-- Empty states -->
                    <umb-empty-state ng-if="vm.logItems.totalItems === 0" position="center">
                        <localize key="general_searchNoResult"></localize>
                    </umb-empty-state>

                    <!-- Main Log Table -->
                    <umb-box data-element="node-info-history" ng-if="!vm.logsLoading && vm.logItems.totalItems > 0">
                        <umb-box-content class="block-form">
                            <div ng-if="vm.logItems.totalItems > 0">
                                Total Items: {{ vm.logItems.totalItems }}
                            </div>

                            <table class="table table-hover" ng-if="vm.logItems.totalItems > 0">
                                <thead>
                                    <tr>
                                        <th style="min-width:100px;" ng-click="vm.toggleOrderBy()">
                                            Timestamp
                                            <ins class="icon-navigation-down" ng-class="{'icon-navigation-down': vm.logOptions.orderDirection === 'Descending', 'icon-navigation-up': vm.logOptions.orderDirection !== 'Descending'}">&nbsp;</ins>
                                        </th>
                                        <th>Level</th>
                                        <th>Machine Name</th>
                                        <th>Message</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat-start="log in vm.logItems.items" ng-click="log.open = !log.open">
                                        <td>{{ log.Timestamp | date:'medium' }}</td>
                                        <td><umb-badge size="s" color="{{ log.logTypeColor }}">{{ log.Level }}</umb-badge></td>
                                        <td>{{ log.Properties.MachineName.Value }}</td>
                                        <td>{{ log.RenderedMessage }}</td>
                                    </tr>

                                    <!-- Log Details (Exception & Properties) -->
                                    <tr ng-repeat-end ng-if="log.open">
                                        <td colspan="4">
                                            <div ng-if="log.Exception" style="border-left:4px solid #fe6561; padding:0 10px 10px 10px; box-shadow:rgba(0,0,0,0.07) 2px 2px 10px">
                                                <h3 style="color:#fe6561;">Exception</h3>
                                                <p style="white-space: pre-wrap;">{{ log.Exception }}</p>
                                            </div>

                                            <h3>Properties</h3>
                                            <div ng-repeat="(key, val) in log.Properties">
                                                <strong>{{ key }}</strong> {{ val.Value }}
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Pagination -->
                            <div ng-if="!vm.loading" class="flex justify-center">
                                <umb-pagination
                                    ng-if="vm.logItems.totalPages"
                                    page-number="vm.logItems.pageNumber"
                                    total-pages="vm.logItems.totalPages"
                                    on-change="vm.changePageNumber(pageNumber)">
                                </umb-pagination>
                            </div>

                        </umb-box-content>
                    </umb-box>
                </div>

                <div class="umb-package-details__sidebar">

                    <!-- No of Errors -->
                    <umb-box data-element="node-info-scheduled-publishing">
                        <umb-box-header>Number of Errors</umb-box-header>
                        <umb-box-content class="block-form" style="font-size: 40px; font-weight:900; text-align:center; color:#fe6561;">
                            {{ vm.numberOfErrors }}
                        </umb-box-content>
                    </umb-box>

                    <!-- Chart of diff log types -->
                    <umb-box data-element="node-info-scheduled-publishing">
                        <umb-box-header>Log Types</umb-box-header>
                        <umb-box-content class="block-form">

                            <canvas
                                chart-doughnut
                                chart-data="vm.logTypeData"
                                chart-labels="vm.logTypeLabels"
                                chart-colors="vm.logTypeColors"
                                chart-options="vm.chartOptions"></canvas>

                        </umb-box-content>
                    </umb-box>

                    <!-- List of top 5 common log messages -->
                    <umb-box data-element="node-info-scheduled-publishing" ng-if="vm.commonLogMessages">
                            <umb-box-header>Common Log Messages</umb-box-header>
                            <umb-box-content class="block-form">
                                <em>Total Unique Message types</em>: {{ vm.commonLogMessages.length }}
                                    <table class="table table-hover">
                                        <tbody>
                                            <tr ng-repeat="template in vm.commonLogMessages | limitTo:10">
                                                <td>
                                                    {{ template.MessageTemplate }}
                                                </td>
                                                <td>
                                                    {{ template.Count }}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                            </umb-box-content>
                        </umb-box>
                </div>
            </div>

        </umb-editor-container>

    </umb-editor-view>

</div>
